#!/usr/bin/env python2
import re
from bs4 import BeautifulSoup as bs4
import requests
import urllib
import hashlib
import time
import socket
from Crypto.Hash import RIPEMD

TCP_IP = '35.165.205.141'
TCP_PORT = 5050
BUFFER_SIZE = 10240000
MESSAGE = ""
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((TCP_IP, TCP_PORT))

while True:
    data = s.recv(BUFFER_SIZE)
    while data == '':
        data = s.recv(BUFFER_SIZE)
    if 'Round 2' in data:
        break

    data = data.split('\n')
    print data
    if len(data) > 3:
        data = data[2]
    else:
        data = data[1]
    print data

    k = data.split()
    print k
    hs =  k[1][:-1]
    print hs
    pasw = k[3][:-1] + k[7] + k[5][:-1]
    print pasw

    if hs == 'md5':
        m = hashlib.md5()
    elif hs == 'sha1':
        m = hashlib.sha1()
    elif hs == 'sha256':
        m = hashlib.sha256()
    elif hs == 'sha384':
        m = hashlib.sha384()
    elif hs == 'sha512':
        m = hashlib.sha512()
    elif hs == "rmd160":
        m = RIPEMD.new()
    else:
        print "hash function unknown", hs
        exit(1)

    m.update(pasw)

    s.send(m.hexdigest() + '\n')

tstamp = time.time()
while True:
    print "I am in round 2!!"
    name = re.findall(r"Name: (.*?),", data)[0].strip()
    print name
    ua = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.110 Safari/537.36'
    headers = {
            'User-Agent': ua
    }
    r = requests.get("https://www.google.co.in/search?q=" + urllib.quote(name) + "+movie", headers=headers)
    soup = bs4(r.text.encode('utf-8').replace("<", "\n<").replace(">", ">\n").replace(":", ""), 'html.parser')
    k = [k for k in soup.get_text().encode('utf-8').split("\n") if k.strip() != ""]

    inrel = False
    director = False
    release = False

    for i, m in enumerate(k):
        if 'Director' in m:
            if not director:
                director = k[i+1]
        elif 'Initial release' in m:
            if not inrel:
                inrel = re.findall(r"\d\d\d\d", k[i+1])[0]
        elif 'Release date' in m:
            if not release:
                release = re.findall(r"\d\d\d\d", k[i+1])[0]

    if re.findall(r"Director: (.*?),", data)[0].strip() == "??":
        if director:
            ans = director
        else:
            ans = "lololol"
    elif re.findall(r"Year: (.*)", data)[0].strip() == "??":
        if inrel:
            ans = inrel
        elif release:
            ans = release
        else:
            print "Could not find release year"
            ans = 2000
    else:
        print "I didn't understand the question"
        exit(1)
    stime = 3 - (time.time() - tstamp)

    if stime > 0:
        time.sleep(stime)

    s.send(ans + '\n')
    data = s.recv(BUFFER_SIZE)
    tstamp = time.time()
    print repr(data)
    while data == '':
        data = s.recv(BUFFER_SIZE)
s.close()
